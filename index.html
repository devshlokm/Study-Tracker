<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Study Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #1a1a1a;
            --card-bg: #ffffff;
            --card-border: #e5e5e5;
            --primary-btn-bg: #1a1a1a;
            --primary-btn-text: #ffffff;
            --secondary-btn-bg: #ffffff;
            --secondary-btn-text: #1a1a1a;
            --secondary-btn-border: #e5e5e5;
            --progress-bar-bg: #e5e5e5;
            --progress-bar-fill: #1a1a1a;
            --text-muted: #6b7280;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
        }

        .dark {
            --bg-color: #1a1a1a;
            --text-color: #f5f5f5;
            --card-bg: #2a2a2a;
            --card-border: #444444;
            --primary-btn-bg: #f5f5f5;
            --primary-btn-text: #1a1a1a;
            --secondary-btn-bg: #2a2a2a;
            --secondary-btn-text: #f5f5f5;
            --secondary-btn-border: #444444;
            --progress-bar-bg: #444444;
            --progress-bar-fill: #f5f5f5;
            --text-muted: #9ca3af;
            --input-bg: #3a3a3a;
            --input-border: #555555;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .font-lora {
            font-family: 'Lora', serif;
        }
        .card {
            background-color: var(--card-bg);
            border-color: var(--card-border);
            border-radius: 1rem;
            border-width: 1px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--primary-btn-bg);
            color: var(--primary-btn-text);
        }
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: var(--secondary-btn-bg);
            color: var(--secondary-btn-text);
            border-color: var(--secondary-btn-border);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--secondary-btn-border);
        }
        .progress-bar-bg {
            background-color: var(--progress-bar-bg);
        }
        .progress-bar-fill {
            background-color: var(--progress-bar-fill);
            transition: width 0.5s ease-in-out;
        }
        .calendar-day {
            width: 2.5rem;
            height: 2.5rem;
        }
        .studied-day {
            background-color: var(--text-color) !important;
            color: var(--bg-color) !important;
            border-radius: 50%;
        }
        .today {
             border: 2px solid var(--text-color);
             border-radius: 50%;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
             transform: scale(0.95);
             transition: transform 0.3s ease;
        }
        .modal:not(.hidden) .modal-content {
             transform: scale(1);
        }
        .plant-svg path, .plant-svg circle {
            stroke: var(--text-color);
            fill: var(--text-color);
            transition: all 0.3s ease;
        }
        .plant-svg {
            transition: opacity 0.8s ease-in-out;
        }
        .text-muted {
            color: var(--text-muted);
        }
        input[type="text"], textarea {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-color);
        }
        input[type="text"]::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }
        input[type="checkbox"] {
            color: var(--text-color);
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--text-color);
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Login Screen -->
        <div id="login-screen" class="text-center py-24 hidden">
             <h1 class="text-5xl font-bold font-lora mb-4">Welcome to Zenith</h1>
             <p class="text-xl text-muted mb-8">Sign in to track your progress and conquer your goals.</p>
             <button id="signInBtn" class="btn btn-primary text-lg inline-flex items-center space-x-3">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.59,44,31.016,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                <span>Sign in with Google</span>
             </button>
        </div>

        <!-- Main App Content (hidden until login) -->
        <div id="main-content" class="hidden">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold font-lora">Zenith Study Tracker</h1>
                    <p class="text-lg text-muted">Your daily climb towards the peak. Goal: Get into Google.</p>
                </div>
                <div class="flex items-center space-x-6 mt-4 md:mt-0">
                    <div id="user-profile" class="flex items-center space-x-3 hidden">
                        <img id="user-avatar" class="avatar" src="" alt="User Avatar">
                        <span id="user-name" class="font-medium"></span>
                        <button id="signOutBtn" class="text-sm text-muted hover:text-red-500 transition-colors">Sign Out</button>
                    </div>
                    <!-- Theme Toggle -->
                    <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" value="" id="theme-toggle" class="sr-only peer">
                        <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-gray-800"></div>
                    </label>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Timer and Controls -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="card p-8 text-center flex flex-col items-center justify-center">
                        <div class="flex items-center justify-around w-full max-w-md mb-4">
                            <h2 class="text-2xl font-bold">Daily Goal: 8 Hours</h2>
                            <div class="text-center">
                                <p class="text-lg">Streak</p>
                                <p id="streak" class="text-3xl font-bold">0</p>
                            </div>
                        </div>
                        <div id="plant-container" class="relative w-48 h-48 mb-4">
                            <svg id="plant-stage-0" class="plant-svg absolute inset-0 w-full h-full" viewBox="0 0 100 100"><path d="M50 85 C45 80, 45 70, 50 70 S55 80, 50 85" fill="none" stroke-width="2" stroke-linecap="round"></path><path d="M48 70 C45 65, 45 55, 48 55" fill="none" stroke-width="2" stroke-linecap="round"></path></svg>
                            <svg id="plant-stage-1" class="plant-svg absolute inset-0 w-full h-full opacity-0" viewBox="0 0 100 100"><path d="M50 85 V60" fill="none" stroke-width="2"></path><path d="M50 70 C40 65, 40 55, 50 50" fill="none" stroke-width="2"></path><path d="M50 70 C60 65, 60 55, 50 50" fill="none" stroke-width="2"></path></svg>
                            <svg id="plant-stage-2" class="plant-svg absolute inset-0 w-full h-full opacity-0" viewBox="0 0 100 100"><path d="M50 85 V50" fill="none" stroke-width="2"></path><path d="M50 65 C35 60, 35 45, 50 40" fill="none" stroke-width="2"></path><path d="M50 65 C65 60, 65 45, 50 40" fill="none" stroke-width="2"></path><path d="M50 55 C40 50, 40 40, 50 35" fill="none" stroke-width="2"></path><path d="M50 55 C60 50, 60 40, 50 35" fill="none" stroke-width="2"></path></svg>
                            <svg id="plant-stage-3" class="plant-svg absolute inset-0 w-full h-full opacity-0" viewBox="0 0 100 100"><path d="M50 85 V40" fill="none" stroke-width="2"></path><path d="M50 75 C30 70, 30 50, 50 45" fill="none" stroke-width="2"></path><path d="M50 75 C70 70, 70 50, 50 45" fill="none" stroke-width="2"></path><path d="M50 60 C35 55, 35 40, 50 35" fill="none" stroke-width="2"></path><path d="M50 60 C65 55, 65 40, 50 35" fill="none" stroke-width="2"></path><path d="M50 50 C40 45, 40 35, 50 30" fill="none" stroke-width="2"></path><path d="M50 50 C60 45, 60 35, 50 30" fill="none" stroke-width="2"></path></svg>
                            <svg id="plant-stage-4" class="plant-svg absolute inset-0 w-full h-full opacity-0" viewBox="0 0 100 100"><path d="M50 85 V30" fill="none" stroke-width="3"></path><path d="M50 80 C25 75, 25 50, 50 40" fill="none" stroke-width="2"></path><path d="M50 80 C75 75, 75 50, 50 40" fill="none" stroke-width="2"></path><path d="M50 65 C30 60, 30 40, 50 35" fill="none" stroke-width="2"></path><path d="M50 65 C70 60, 70 40, 50 35" fill="none" stroke-width="2"></path><path d="M50 50 C35 45, 35 30, 50 25" fill="none" stroke-width="2"></path><path d="M50 50 C65 45, 65 30, 50 25" fill="none" stroke-width="2"></path><circle cx="35" cy="20" r="5"></circle><circle cx="65" cy="20" r="5"></circle></svg>
                        </div>
                        <div id="timer" class="text-6xl font-bold mb-4">00:00:00</div>
                        <div class="w-full max-w-md mb-6">
                            <div class="progress-bar-bg w-full h-2 rounded-full">
                                <div id="progressBar" class="progress-bar-fill h-2 rounded-full" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button id="startPauseBtn" class="btn btn-primary">Start</button>
                            <button id="resetBtn" class="btn btn-secondary">Reset Today</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Today's Log</h3>
                            <p class="text-sm text-muted mb-2">What did you conquer today?</p>
                            <textarea id="dailyLog" class="w-full h-48 p-3 border rounded-lg focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent transition" placeholder="e.g., Solved 5 medium LeetCode problems..."></textarea>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center justify-between mb-4">
                               <h3 class="text-xl font-bold">Today's Tasks</h3>
                               <button id="planDayBtn" class="btn btn-secondary text-sm py-1 px-3 flex items-center space-x-2" disabled>
                                   <span>✨ Plan My Day</span>
                               </button>
                            </div>
                            <p class="text-xs text-muted -mt-3 mb-3 text-right">Temporarily disabled due to API key security.</p>
                            <div class="flex mb-4">
                                <input type="text" id="todoInput" class="w-full p-2 border rounded-l-lg focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent transition" placeholder="Add a new task...">
                                <button id="addTodoBtn" class="btn btn-primary rounded-l-none">Add</button>
                            </div>
                            <ul id="todoList" class="space-y-2"></ul>
                        </div>
                    </div>
                </div>
                <div class="space-y-8">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="calendar-month-year" class="text-xl font-bold"></h3>
                            <div>
                                <button id="prev-month" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&lt;</button>
                                <button id="next-month" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&gt;</button>
                            </div>
                        </div>
                        <div id="calendar" class="grid grid-cols-7 gap-1 text-center"></div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-2">✨ Google Prep Hack</h3>
                        <p id="prepTip" class="text-muted font-lora italic min-h-[60px]">Loading a fresh tip...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="rewardModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content card p-8 text-center max-w-md">
            <h2 class="text-3xl font-bold font-lora mb-2">Congratulations!</h2>
            <p class="text-lg mb-4">You've completed your 8 hours. Another step closer to your goal!</p>
            <svg class="w-24 h-24 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <p class="mb-6">Your streak has increased. Keep the momentum going!</p>
            <button id="closeModalBtn" class="btn btn-primary">Awesome!</button>
        </div>
    </div>
    <div id="confirmModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content card p-8 text-center max-w-sm">
            <h2 id="confirmTitle" class="text-2xl font-bold font-lora mb-4">Are you sure?</h2>
            <p id="confirmText" class="text-lg mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYesBtn" class="btn btn-primary bg-red-600 hover:bg-red-700">Yes, proceed</button>
                <button id="confirmNoBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    <div id="loadingModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content card p-8 text-center max-w-sm">
            <h2 id="loadingTitle" class="text-2xl font-bold font-lora mb-4">Working on it...</h2>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-current mx-auto"></div>
            <p id="loadingText" class="text-lg mt-4 text-muted">Generating insights with Gemini...</p>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyAv5xglpiRrB4VgouaNah6yx5y76abC44g",
          authDomain: "zenith-study-tracker.firebaseapp.com",
          projectId: "zenith-study-tracker",
          storageBucket: "zenith-study-tracker.appspot.com",
          messagingSenderId: "139224303940",
          appId: "1:139224303940:web:01bd2df00e0d90de146f11",
          measurementId: "G-ERZN5GL8K2"
        };

        // --- App State ---
        let db, auth, userId;
        let timerInterval = null;
        let totalSeconds = 0;
        const GOAL_SECONDS = 8 * 60 * 60;
        let isRunning = false;
        let goalReachedToday = false;
        let currentDate = new Date();
        let studiedDates = new Set();
        let unsubscribes = [];
        let confirmCallback = null;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userProfile = document.getElementById('user-profile');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const themeToggle = document.getElementById('theme-toggle');
        const timerDisplay = document.getElementById('timer');
        const progressBar = document.getElementById('progressBar');
        const startPauseBtn = document.getElementById('startPauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const streakDisplay = document.getElementById('streak');
        const dailyLog = document.getElementById('dailyLog');
        const todoInput = document.getElementById('todoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList');
        const planDayBtn = document.getElementById('planDayBtn');
        const calendarEl = document.getElementById('calendar');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const prepTipEl = document.getElementById('prepTip');
        const rewardModal = document.getElementById('rewardModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmText = document.getElementById('confirmText');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const loadingModal = document.getElementById('loadingModal');
        const plantStages = [
            document.getElementById('plant-stage-0'), document.getElementById('plant-stage-1'),
            document.getElementById('plant-stage-2'), document.getElementById('plant-stage-3'),
            document.getElementById('plant-stage-4'),
        ];

        // --- Utility Functions ---
        const getTodayString = (date = new Date()) => date.toISOString().split('T')[0];
        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        };
        const showModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => modalElement.classList.remove('opacity-0', 'pointer-events-none'), 10);
        };
        const hideModal = (modalElement) => {
            modalElement.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => modalElement.classList.add('hidden'), 300);
        };
        const showConfirmModal = (title, text, callback) => {
            confirmTitle.textContent = title;
            confirmText.textContent = text;
            confirmCallback = callback;
            showModal(confirmModal);
        };
        const hideConfirmModal = () => {
            hideModal(confirmModal);
            confirmCallback = null;
        };

        // --- Gemini API Functions ---
        const API_KEY = ""; // Kept empty for security, will be handled by environment if needed
        const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        async function callGeminiAPI(payload) {
            try {
                const response = await fetch(API_URL_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                }
                console.error("Unexpected API response structure:", result);
                return null;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return null;
            }
        }

        async function getDynamicPrepTip() {
            prepTipEl.textContent = "Loading a fresh tip...";
            const payload = { contents: [{ parts: [{ text: "Generate one unique, insightful, and practical tip or hack for someone preparing for a software engineering interview at Google. The tip should be concise and under 250 characters." }] }] };
            const tip = await callGeminiAPI(payload);
            prepTipEl.textContent = tip || "Master the STAR method for behavioral questions. Practice telling your project stories in this format.";
        }

        // --- Auth Logic ---
        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithPopup(auth, provider);
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user') {
                    console.error("Google Sign-In failed:", error);
                } else {
                    console.log("Sign-in popup closed by user.");
                }
            }
        };

        const signOutUser = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign-out failed:", error);
            }
        };

        // --- Theme Logic ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            themeToggle.checked = theme === 'dark';
        }

        async function saveThemePreference(theme) {
            if (!userId) {
                localStorage.setItem('theme', theme);
                return;
            }
            const settingsRef = doc(db, `users/${userId}/settings`, 'theme');
            await setDoc(settingsRef, { preference: theme });
        }

        async function loadThemePreference() {
            if (!userId) {
                applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
                return;
            }
            const settingsRef = doc(db, `users/${userId}/settings`, 'theme');
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                applyTheme(docSnap.data().preference);
            } else {
                applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            }
        }

        // --- Timer & Data Logic ---
        function startTimer() {
            if (isRunning || goalReachedToday) return;
            isRunning = true;
            startPauseBtn.textContent = 'Pause';
            startPauseBtn.classList.replace('btn-primary', 'btn-secondary');
            timerInterval = setInterval(updateTimer, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;
            isRunning = false;
            startPauseBtn.textContent = 'Start';
            startPauseBtn.classList.replace('btn-secondary', 'btn-primary');
            clearInterval(timerInterval);
            if (userId) saveProgress();
        }

        function updateTimer() {
            totalSeconds++;
            updateUI();
            if (totalSeconds >= GOAL_SECONDS) handleGoalCompletion();
        }

        function updateUI() {
            timerDisplay.textContent = formatTime(totalSeconds);
            const progressPercentage = Math.min((totalSeconds / GOAL_SECONDS) * 100, 100);
            progressBar.style.width = `${progressPercentage}%`;
            updatePlantStage(progressPercentage);
        }

        function updatePlantStage(percentage) {
            const stage = Math.min(Math.floor(percentage / 25), 4);
            plantStages.forEach((s, i) => s.style.opacity = (i === stage) ? '1' : '0');
        }
        
        async function handleGoalCompletion() {
            if (goalReachedToday) return;
            goalReachedToday = true;
            totalSeconds = GOAL_SECONDS;
            pauseTimer();
            updateUI();
            startPauseBtn.disabled = true;
            startPauseBtn.textContent = 'Completed!';
            showModal(rewardModal);
            studiedDates.add(getTodayString());
            if (userId) {
                await updateStreak();
                await saveProgress();
            }
            renderCalendar();
        }

        async function resetTimer() {
            showConfirmModal("Reset Progress?", "This cannot be undone.", async () => {
                pauseTimer();
                totalSeconds = 0;
                goalReachedToday = false;
                startPauseBtn.disabled = false;
                startPauseBtn.textContent = 'Start';
                updateUI();
                if (userId) await saveProgress();
            });
        }

        async function saveProgress() {
            if (!userId) return;
            const progressRef = doc(db, `users/${userId}/progress`, getTodayString());
            await setDoc(progressRef, { seconds: totalSeconds, goalReached: goalReachedToday });
        }

        async function loadProgress() {
            if (!userId) return;
            const progressRef = doc(db, `users/${userId}/progress`, getTodayString());
            const docSnap = await getDoc(progressRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                totalSeconds = data.seconds || 0;
                goalReachedToday = data.goalReached || false;
                if (goalReachedToday) {
                    totalSeconds = GOAL_SECONDS;
                    startPauseBtn.disabled = true;
                    startPauseBtn.textContent = 'Completed!';
                }
            } else {
                totalSeconds = 0;
                goalReachedToday = false;
            }
            updateUI();
        }

        async function updateStreak() {
            if (!userId) return;
            const streakRef = doc(db, `users/${userId}/data`, 'streak');
            const docSnap = await getDoc(streakRef);
            let currentStreak = 0;
            let lastUpdate = null;
            if (docSnap.exists()) {
                currentStreak = docSnap.data().count || 0;
                if (docSnap.data().lastUpdate) lastUpdate = docSnap.data().lastUpdate.toDate();
            }
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            if (!lastUpdate || lastUpdate.toDateString() !== today.toDateString()) {
                currentStreak = (lastUpdate && lastUpdate.toDateString() === yesterday.toDateString()) ? currentStreak + 1 : 1;
                await setDoc(streakRef, { count: currentStreak, lastUpdate: new Date() });
            }
        }

        function listenToStreak() {
            if (!userId) return;
            const streakRef = doc(db, `users/${userId}/data`, 'streak');
            unsubscribes.push(onSnapshot(streakRef, (docSnap) => {
                streakDisplay.textContent = docSnap.exists() ? docSnap.data().count || 0 : 0;
            }));
        }

        function listenToDailyLog() {
            if (!userId) return;
            const logRef = doc(db, `users/${userId}/logs`, getTodayString());
            unsubscribes.push(onSnapshot(logRef, (docSnap) => {
                dailyLog.value = docSnap.exists() ? docSnap.data().content || '' : '';
            }));
        }

        dailyLog.addEventListener('blur', () => {
            if (!userId) return;
            const logRef = doc(db, `users/${userId}/logs`, getTodayString());
            setDoc(logRef, { content: dailyLog.value }, { merge: true });
        });

        function listenToTodos() {
            if (!userId) return;
            const q = query(collection(db, `users/${userId}/todos`), where("date", "==", getTodayString()));
            unsubscribes.push(onSnapshot(q, (querySnapshot) => {
                todoList.innerHTML = '';
                querySnapshot.forEach((doc) => renderTodoItem(doc.id, doc.data()));
            }));
        }
        
        async function addTodo() {
            const taskText = todoInput.value.trim();
            if (taskText === '' || !userId) return;
            await addDoc(collection(db, `users/${userId}/todos`), { text: taskText, completed: false, date: getTodayString() });
            todoInput.value = '';
        }

        function renderTodoItem(id, data) {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700';
            li.dataset.id = id;
            li.innerHTML = `
                <input type="checkbox" ${data.completed ? 'checked' : ''} class="form-checkbox h-5 w-5 rounded focus:ring-black dark:focus:ring-white">
                <span class="flex-grow mx-4 ${data.completed ? 'line-through text-muted' : ''}">${data.text}</span>
                <button class="delete-btn text-red-500 font-bold text-xl hover:text-red-700">×</button>
            `;
            li.querySelector('input[type="checkbox"]').addEventListener('change', () => toggleTodo(id, !data.completed));
            li.querySelector('.delete-btn').addEventListener('click', () => deleteTodo(id));
            todoList.appendChild(li);
        }

        async function toggleTodo(id, completed) {
            if (!userId) return;
            await updateDoc(doc(db, `users/${userId}/todos`, id), { completed });
        }

        async function deleteTodo(id) {
            if (!userId) return;
            await deleteDoc(doc(db, `users/${userId}/todos`, id));
        }
        
        async function loadStudiedDays() {
            if (!userId) return;
            const q = query(collection(db, `users/${userId}/progress`), where("goalReached", "==", true));
            const querySnapshot = await getDocs(q);
            studiedDates.clear();
            querySnapshot.forEach(doc => studiedDates.add(doc.id));
            renderCalendar();
        }

        function renderCalendar() {
            calendarEl.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            calendarMonthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-bold text-muted';
                dayEl.textContent = day;
                calendarEl.appendChild(dayEl);
            });
            for (let i = 0; i < new Date(year, month, 1).getDay(); i++) calendarEl.appendChild(document.createElement('div'));
            const todayString = getTodayString(new Date());
            for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'calendar-day flex items-center justify-center cursor-default';
                const dayString = getTodayString(new Date(year, month, day));
                if (studiedDates.has(dayString)) dayEl.classList.add('studied-day');
                if (dayString === todayString) dayEl.classList.add('today');
                calendarEl.appendChild(dayEl);
            }
        }

        // --- Event Listeners ---
        themeToggle.addEventListener('change', (e) => {
            const newTheme = e.target.checked ? 'dark' : 'light';
            applyTheme(newTheme);
            saveThemePreference(newTheme);
        });
        signInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOutUser);
        startPauseBtn.addEventListener('click', () => { isRunning ? pauseTimer() : startTimer(); });
        resetBtn.addEventListener('click', resetTimer);
        addTodoBtn.addEventListener('click', addTodo);
        todoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); });
        planDayBtn.addEventListener('click', () => alert("This feature is temporarily disabled while we improve our API security. Coming soon!"));
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        closeModalBtn.addEventListener('click', () => hideModal(rewardModal));
        confirmYesBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmModal(); });
        confirmNoBtn.addEventListener('click', hideConfirmModal);

        // --- Initialization ---
        function resetUI() {
            streakDisplay.textContent = '0';
            todoList.innerHTML = '';
            dailyLog.value = '';
            totalSeconds = 0;
            updateUI();
        }

        async function main() {
            if (!firebaseConfig) {
                console.error("Firebase is not configured.");
                loginScreen.classList.remove('hidden');
                signInBtn.disabled = true;
                signInBtn.textContent = 'Configuration Error';
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            try {
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Setting persistence failed", error);
            }

            onAuthStateChanged(auth, async (user) => {
                unsubscribes.forEach(unsub => unsub());
                unsubscribes = [];

                if (user) {
                    userId = user.uid;
                    userName.textContent = user.displayName;
                    userAvatar.src = user.photoURL;
                    userProfile.classList.remove('hidden');
                    
                    loginScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    
                    await loadThemePreference();
                    await loadProgress();
                    await loadStudiedDays();
                    await getDynamicPrepTip();
                    listenToStreak();
                    listenToDailyLog();
                    listenToTodos();
                    
                    if (window.saveInterval) clearInterval(window.saveInterval);
                    window.saveInterval = setInterval(saveProgress, 30000);
                } else {
                    userId = null;
                    mainContent.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                    resetUI();
                }
            });
        }
        
        main();
    </script>
</body>
</html>
